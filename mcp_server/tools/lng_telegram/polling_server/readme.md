# Telegram Polling Server

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Telegram –±–æ—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–µ—Å—Å–∏–π –∏ pipeline –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### ü§ñ –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- **Polling —Ä–µ–∂–∏–º** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Telegram API
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏** - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–≤—ã–º–∏ —á–∞—Ç–∞–º–∏ —Å UUID
- **Deep Links** - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫–∏ –≤–∏–¥–∞ `https://t.me/bot?start=uuid`
- **Pipeline –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- **–°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### üîß –û–ø–µ—Ä–∞—Ü–∏–∏

#### `start` - –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
```json
{
  "operation": "start",
  "token": "YOUR_BOT_TOKEN",
  "pipeline": [
    {
      "tool": "lng_count_words",
      "params": {"input_text": "{! telegram.message !}"},
      "output": "word_stats"
    }
  ]
}
```

#### `stop` - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
```json
{
  "operation": "stop"
}
```

#### `send_message` - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```json
{
  "operation": "send_message",
  "user_id": 123456789,
  "message": "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"
}
```

#### `send_to_session` - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–º –≤ —Å–µ—Å—Å–∏–∏
```json
{
  "operation": "send_to_session",
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "message": "–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤",
  "exclude_user": 123456789
}
```

#### `status` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞
```json
{
  "operation": "status"
}
```

## –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ê ‚Üí /start ‚Üí –ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç UUID —Å–µ—Å—Å–∏—é ‚Üí –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
```

### 2. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —Å–µ—Å—Å–∏–∏  
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë ‚Üí –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –∫ —Å–µ—Å—Å–∏–∏
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```
–°–æ–æ–±—â–µ–Ω–∏–µ ‚Üí Pipeline –æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
```

### Pipeline –∫–æ–Ω—Ç–µ–∫—Å—Ç
–í pipeline –¥–æ—Å—Ç—É–ø–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
```json
{
  "telegram": {
    "user_id": 123456789,
    "message": "—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
    "user_state": {...},
    "session_state": {...},
    "update": "telegram_update_object",
    "bot": "server_instance"
  }
}
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ—Å—Ç–æ–π —ç—Ö–æ-–±–æ—Ç
```json
{
  "operation": "start",
  "pipeline": [
    {
      "tool": "lng_telegram_polling_server",
      "params": {
        "operation": "send_message",
        "user_id": "{! telegram.user_id !}",
        "message": "–í—ã –Ω–∞–ø–∏—Å–∞–ª–∏: {! telegram.message !}"
      }
    }
  ]
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ LLM
```json
{
  "operation": "start",
  "pipeline": [
    {
      "tool": "lng_llm_chain_of_thought",
      "params": {
        "question": "{! telegram.message !}"
      },
      "output": "llm_response"
    },
    {
      "tool": "lng_telegram_polling_server", 
      "params": {
        "operation": "send_message",
        "user_id": "{! telegram.user_id !}",
        "message": "{! llm_response.answer !}"
      }
    }
  ]
}
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π

### UserState
```python
@dataclass
class UserState:
    user_id: int
    username: str
    first_name: str
    session_id: Optional[str] = None
    current_message_processing: Optional[str] = None
    joined_at: Optional[str] = None
```

### SessionState  
```python
@dataclass
class SessionState:
    session_id: str
    participants: List[int]
    created_at: str
    last_activity: str
    message_queue: List[Dict] = None
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- `python-telegram-bot` - –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram API
- `asyncio` - –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `python-dotenv` - –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –¢–æ–∫–µ–Ω –±–æ—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç–µ –≤ `.env` —Ñ–∞–π–ª–µ
- UUID —Å–µ—Å—Å–∏–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –ù–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
